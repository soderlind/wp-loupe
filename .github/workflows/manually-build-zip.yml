name: Manually Build release zip

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy'
        required: true
        type: string
        default: ''

jobs:
  build:
    name: Build release zip
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build plugin
        run: composer install --no-dev --optimize-autoloader

      - name: Stage release files
        run: |
          mkdir -p /tmp/wp-loupe
          rsync -a \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.gitattributes' \
            --exclude='.gitignore' \
            --exclude='.phpunit.cache/' \
            --exclude='node_modules/' \
            --exclude='tests/' \
            --exclude='docs/' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='phpunit.xml.dist' \
            --exclude='debug.php' \
            --exclude='test-mcp-search.sh' \
            --exclude='mcp-design.md' \
            --exclude='TODO.md' \
            --exclude='CHANGELOG.md' \
            --exclude='README.md' \
            --exclude='.editorconfig' \
            --exclude='.wp-env.json' \
            --exclude='vendor/bin/' \
            . /tmp/wp-loupe/

      - name: Archive Release
        working-directory: /tmp
        run: zip -r ${{ github.workspace }}/wp-loupe.zip wp-loupe/

      - name: Create release and upload zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.event.inputs.tag }}" \
            wp-loupe.zip \
            --title "${{ github.event.inputs.tag }}" \
            --generate-notes
